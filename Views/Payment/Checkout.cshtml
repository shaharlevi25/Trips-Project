
@model TripsProject.Models.TravelPackage
@{
    ViewData["Title"] = "Checkout";
    var total = Model.DiscountedPrice ?? Model.Price;
}

<div class="checkout-wrapper">
    <div class="checkout-card">
        <h2>Secure Checkout</h2>
        <p>Select your payment method</p>

        <div class="price-box">
            Total to pay: ‚Ç™@total
        </div>

        @* Optional: show discount details *@
        @if (Model.DiscountedPrice.HasValue && Model.DiscountPercent.HasValue)
        {
            <div class="discount-info">
                <span class="old-price">‚Ç™@Model.Price</span>
                <span class="discount-badge">@Model.DiscountPercent% OFF</span>
            </div>
        }

        <div class="timer-box">
            ‚è≥ Time left to pay:
            <span id="timer">--:--</span>
        </div>

        <div id="paypal-button-container"></div>

        <div class="secure-text">
            üîí Secure payment ‚Ä¢ No real charge (Sandbox)
        </div>
    </div>
</div>

<style>
    .checkout-wrapper {
        min-height: 70vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f5f7fa;
    }

    .checkout-card {
        background: #ffffff;
        padding: 40px 35px;
        border-radius: 16px;
        width: 100%;
        max-width: 420px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
        text-align: center;
    }

    .checkout-card h2 {
        margin-bottom: 10px;
        font-size: 24px;
        color: #1f2937;
    }

    .checkout-card p {
        font-size: 15px;
        color: #6b7280;
        margin-bottom: 25px;
    }

    .price-box {
        background: #f0f4ff;
        color: #1d4ed8;
        font-size: 20px;
        font-weight: bold;
        padding: 14px;
        border-radius: 10px;
        margin-bottom: 10px;
    }

    .discount-info {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-bottom: 25px;
    }

    .old-price {
        color: #6b7280;
        text-decoration: line-through;
        font-size: 16px;
    }

    .discount-badge {
        background: #fee2e2;
        color: #b91c1c;
        font-weight: 700;
        font-size: 13px;
        padding: 6px 10px;
        border-radius: 999px;
    }

    .secure-text {
        margin-top: 18px;
        font-size: 13px;
        color: #9ca3af;
    }

    .timer-box {
        margin-bottom: 15px;
        font-size: 16px;
        color: #dc2626;
        font-weight: bold;
    }
</style>

@section Scripts {
    <script src="https://www.paypal.com/sdk/js?client-id=AUIimViTH8m2sDNv8d9Osd9xex0s3b6bmxiXfb8Zx9IGHTtPsa_1P5a7qg5OvA1mVY_PhP05dMyZIWDO&currency=ILS"></script>

    <script>
        // Global variable to store the created PayPal OrderId (so we can release reservation on timeout/cancel)
        window.currentPayPalOrderId = null;

        document.addEventListener("DOMContentLoaded", function () {

            const el = document.getElementById("paypal-button-container");
            if (!el) {
                alert("ERROR: #paypal-button-container was not found on the page");
                return;
            }

            paypal.Buttons({
                createOrder: async function () {
                    const packageId = @Model.PackageId;

                    const res = await fetch('/Payment/CreateOrder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ packageId: packageId })
                    });

                    if (!res.ok) {
                        alert(await res.text());
                        throw new Error("CreateOrder failed");
                    }

                    const data = await res.json();

                    // Save the PayPal orderId so we can cancel reservation if needed
                    window.currentPayPalOrderId = data.orderId;

                    return data.orderId;
                },

                onApprove: async function (data) {
                    const res = await fetch('/Payment/Capture', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ orderId: data.orderID })
                    });

                    // Read body once
                    const bodyText = await res.text();

                    if (res.ok) {
                        // Server should return: { success: true, orderId: "..." }
                        const data2 = JSON.parse(bodyText);

                        window.location.href =
                            '/Payment/Success?orderId=' + encodeURIComponent(data2.orderId);
                    } else {
                        alert("Payment error: " + bodyText);
                    }
                },

                onCancel: async function (data) {
                    try {
                        await fetch('/Payment/CancelReservation', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ orderId: data.orderID })
                        });
                    } catch (e) { }

                    window.location.href = '/Payment/Cancel';
                }
            }).render('#paypal-button-container');

        });
    </script>

    <script>
        // Expiration time comes from server (UTC)
        const expireAt = new Date('@ViewBag.ExpireAt.ToString("yyyy-MM-ddTHH:mm:ssZ")');

        function startTimer() {
            const timerEl = document.getElementById("timer");

            const interval = setInterval(async () => {
                const now = new Date();
                const diff = expireAt - now;

                if (diff <= 0) {
                    clearInterval(interval);
                    timerEl.innerText = "00:00";

                    // Release reservation only if a PayPal order was created
                    if (window.currentPayPalOrderId) {
                        try {
                            await fetch('/Payment/CancelReservation', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ orderId: window.currentPayPalOrderId })
                            });
                        } catch (e) { }
                    }

                    alert("Payment time expired. The reservation was cancelled.");
                    window.location.href = '/Payment/Cancel';
                    return;
                }

                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);

                timerEl.innerText =
                    String(minutes).padStart(2, '0') + ":" +
                    String(seconds).padStart(2, '0');

            }, 1000);
        }

        document.addEventListener("DOMContentLoaded", startTimer);
    </script>
}
```
